<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX CORE ‚Äî Forex Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080c10;
  --surface: #0d1117;
  --card: #111820;
  --border: #1e2d3d;
  --accent: #00d4ff;
  --green: #00ff88;
  --gold: #ffd700;
  --red: #ff4444;
  --warn: #ff6b35;
  --text: #e2e8f0;
  --muted: #4a6080;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  min-height: 100vh;
}
body::before {
  content:'';
  position:fixed; inset:0;
  background-image: linear-gradient(rgba(0,212,255,0.025) 1px, transparent 1px), linear-gradient(90deg, rgba(0,212,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events:none; z-index:0;
}
.wrap { max-width:900px; margin:0 auto; padding:0 16px; position:relative; z-index:1; }

/* HEADER */
header { padding:20px 0 16px; border-bottom:1px solid var(--border); margin-bottom:20px; }
.hdr { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; }
.logo { display:flex; align-items:center; gap:10px; }
.logo-hex {
  width:36px; height:36px;
  background: linear-gradient(135deg, var(--accent), var(--green));
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  display:flex; align-items:center; justify-content:center;
  font-family:'Syne',sans-serif; font-weight:800; font-size:13px; color:#000;
}
.logo-text { font-family:'Syne',sans-serif; font-weight:800; font-size:18px; letter-spacing:0.05em; }
.logo-text span { color:var(--accent); }
.logo-sub { font-size:9px; color:var(--muted); letter-spacing:0.15em; margin-top:2px; }

/* API KEY */
.api-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.api-input {
  background: var(--surface); border:1px solid var(--border); color:var(--text);
  font-family:'JetBrains Mono',monospace; font-size:11px;
  padding:7px 12px; border-radius:6px; width:220px;
}
.api-input:focus { outline:none; border-color:var(--accent); }
.btn-save {
  background:rgba(0,212,255,0.1); border:1px solid var(--accent); color:var(--accent);
  font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:0.1em;
  padding:7px 14px; border-radius:6px; cursor:pointer; transition:all 0.2s;
}
.btn-save:hover { background:rgba(0,212,255,0.2); }
.api-ok { font-size:10px; color:var(--green); display:none; }
.api-err { font-size:10px; color:var(--red); display:none; }

/* SETTINGS ROW */
.settings-row {
  display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap:10px; margin-bottom:16px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px; padding:14px;
}
.field label { font-size:9px; letter-spacing:0.12em; color:var(--muted); display:block; margin-bottom:5px; }
select, input[type=number], input[type=text] {
  width:100%; background:var(--card); border:1px solid var(--border);
  color:var(--text); font-family:'JetBrains Mono',monospace; font-size:11px;
  padding:7px 10px; border-radius:6px;
}
select:focus, input:focus { outline:none; border-color:var(--accent); }

/* MODE TOGGLES */
.modes-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px; align-items:center; }
.toggle-btn {
  display:flex; align-items:center; gap:7px; cursor:pointer;
  padding:7px 14px; border-radius:6px; font-size:11px; letter-spacing:0.06em;
  border:1px solid var(--border); background:var(--surface);
  transition:all 0.2s; user-select:none;
}
.toggle-btn input { display:none; }
.toggle-btn.active-backtest { border-color:var(--gold); color:var(--gold); background:rgba(255,215,0,0.06); }
.toggle-btn.active-confirm { border-color:var(--green); color:var(--green); background:rgba(0,255,136,0.06); }
.badge { font-size:9px; padding:2px 8px; border-radius:3px; letter-spacing:0.1em; display:none; }
.badge-bt { background:rgba(255,215,0,0.1); color:var(--gold); border:1px solid rgba(255,215,0,0.3); }
.badge-cf { background:rgba(0,255,136,0.1); color:var(--green); border:1px solid rgba(0,255,136,0.3); }

/* BACKTEST TIME */
#btTimeRow { display:none; margin-bottom:16px; }
#btTimeRow .field label { color:var(--gold); }

/* UPLOAD GRID */
.upload-grid {
  display:grid; grid-template-columns: repeat(3, 1fr);
  gap:8px; margin-bottom:12px;
}
@media(max-width:500px){ .upload-grid { grid-template-columns: repeat(2,1fr); } }
.zone {
  border:1.5px dashed var(--border); border-radius:8px;
  aspect-ratio:16/9; cursor:pointer; position:relative;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px; transition:all 0.2s; overflow:hidden;
  background:var(--surface);
}
.zone:hover { border-color:var(--accent); background:rgba(0,212,255,0.03); }
.zone.has-img { border-color:var(--green); border-style:solid; }
.zone-tf { font-size:10px; letter-spacing:0.12em; color:var(--muted); font-weight:600; }
.zone-hint { font-size:9px; color:var(--muted); }
.zone img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; border-radius:6px; }
.zone-rm {
  position:absolute; top:4px; right:4px; z-index:2;
  background:rgba(255,68,68,0.85); border:none; color:#fff;
  width:16px; height:16px; border-radius:50%; cursor:pointer;
  font-size:9px; display:none; align-items:center; justify-content:center;
}
.zone.has-img .zone-rm { display:flex; }

/* CONFIRM ZONE */
.confirm-zone-wrap {
  border:1px solid rgba(0,255,136,0.25); border-radius:10px;
  padding:12px; margin-bottom:12px;
  background:rgba(0,255,136,0.03);
}
.confirm-zone-label { font-size:9px; letter-spacing:0.12em; color:var(--green); margin-bottom:8px; font-weight:700; }
.confirm-zone {
  border:1.5px dashed rgba(0,255,136,0.3); border-radius:8px;
  padding:14px; text-align:center; cursor:pointer;
  display:flex; align-items:center; justify-content:center; gap:8px;
  position:relative; min-height:54px; transition:border-color 0.2s;
}
.confirm-zone:hover { border-color:var(--green); }
.confirm-zone img { max-height:70px; max-width:100%; border-radius:4px; object-fit:contain; display:none; }
.confirm-zone-hint { font-size:10px; color:var(--muted); }
#cfRm {
  position:absolute; top:4px; right:4px;
  background:rgba(255,68,68,0.85); border:none; color:#fff;
  width:16px; height:16px; border-radius:50%; cursor:pointer;
  font-size:9px; display:none; align-items:center; justify-content:center;
}

/* ACTION BUTTONS */
.action-row { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
.btn-action {
  font-family:'JetBrains Mono',monospace; font-size:10px; letter-spacing:0.1em;
  padding:7px 14px; border-radius:6px; cursor:pointer; border:1px solid; transition:all 0.2s;
  background:transparent;
}
.btn-clear { border-color:var(--muted); color:var(--muted); }
.btn-clear:hover { border-color:var(--red); color:var(--red); }
.btn-reanalyze { border-color:var(--accent); color:var(--accent); }
.btn-reanalyze:hover { background:rgba(0,212,255,0.08); }

/* MAIN ANALYZE BTN */
.analyze-btn {
  width:100%; padding:16px;
  background: linear-gradient(135deg, rgba(0,212,255,0.12), rgba(0,255,136,0.08));
  border:1px solid rgba(0,212,255,0.4); border-radius:10px;
  color:var(--accent); font-family:'Syne',sans-serif; font-weight:700;
  font-size:14px; letter-spacing:0.12em; cursor:pointer;
  transition:all 0.25s; margin-bottom:6px;
}
.analyze-btn:hover:not(:disabled) { background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,255,136,0.12)); border-color:var(--accent); }
.analyze-btn:disabled { opacity:0.5; cursor:not-allowed; }

/* LOADING */
.loading-bar { height:2px; background:var(--border); border-radius:2px; overflow:hidden; margin-bottom:16px; }
.loading-fill { height:100%; width:0; background:linear-gradient(90deg,var(--accent),var(--green)); transition:width 0.3s; }
.loading-bar.active .loading-fill { animation: loadPulse 1.8s ease-in-out infinite; }
@keyframes loadPulse { 0%{width:0;margin-left:0} 50%{width:60%;margin-left:20%} 100%{width:0;margin-left:100%} }

/* RESULTS */
#results { margin-bottom:40px; }
.clear-btn {
  display:block; margin-bottom:8px;
  background:transparent; border:1px solid var(--muted); color:var(--muted);
  font-family:'JetBrains Mono',monospace; font-size:10px; padding:5px 14px;
  border-radius:5px; cursor:pointer; transition:all 0.2s;
}
.clear-btn:hover { border-color:var(--red); color:var(--red); }

.result-card { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:12px; }

/* RESULT HEADER */
.rh { padding:16px 20px; display:flex; justify-content:space-between; align-items:flex-start; }
.rh-buy { background:linear-gradient(135deg, rgba(0,255,136,0.08), rgba(0,255,136,0.03)); border-bottom:1px solid rgba(0,255,136,0.2); }
.rh-sell { background:linear-gradient(135deg, rgba(255,68,68,0.08), rgba(255,68,68,0.03)); border-bottom:1px solid rgba(255,68,68,0.2); }
.rh-neutral { background:linear-gradient(135deg, rgba(0,212,255,0.06), rgba(0,212,255,0.02)); border-bottom:1px solid rgba(0,212,255,0.15); }
.rh-pair { font-family:'Syne',sans-serif; font-size:20px; font-weight:800; }
.rh-time { font-size:10px; color:var(--muted); margin-top:3px; }
.dir-badge { font-family:'Syne',sans-serif; font-weight:700; font-size:11px; letter-spacing:0.1em; padding:5px 14px; border-radius:5px; }
.dir-buy { background:rgba(0,255,136,0.15); color:var(--green); border:1px solid rgba(0,255,136,0.3); }
.dir-sell { background:rgba(255,68,68,0.15); color:var(--red); border:1px solid rgba(255,68,68,0.3); }
.dir-wait { background:rgba(0,212,255,0.1); color:var(--accent); border:1px solid rgba(0,212,255,0.25); }
.rr-tag { font-size:10px; color:var(--muted); margin-top:6px; text-align:right; }

/* RESULT BODY */
.rb { padding:16px 20px; }

/* NEXT ACTION BOX */
.next-action {
  padding:14px 16px; border-radius:8px;
  background:rgba(0,212,255,0.06); border:1px solid rgba(0,212,255,0.2);
  margin-bottom:14px;
}
.na-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.na-label { font-size:9px; letter-spacing:0.15em; color:var(--accent); font-weight:700; }
.expiry-badge { font-size:9px; padding:3px 10px; border-radius:4px; background:rgba(255,165,0,0.1); color:orange; border:1px solid rgba(255,165,0,0.3); font-weight:700; }
.na-text { font-size:12px; color:var(--text); line-height:1.6; }

/* LEVELS GRID */
.lvl-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px; }
@media(max-width:400px){ .lvl-grid { grid-template-columns:1fr; } }
.lvl-box { background:var(--surface); border:1px solid var(--border); border-radius:7px; padding:10px 12px; }
.lvl-title { font-size:9px; letter-spacing:0.12em; color:var(--muted); margin-bottom:5px; }
.lvl-val { font-size:14px; font-weight:600; }
.lvl-entry { color:var(--accent); }
.lvl-sl { color:var(--red); }
.lvl-tp1 { color:var(--green); }
.lvl-tp2 { color:#00e5b0; }
.lvl-sub { font-size:10px; color:var(--muted); margin-left:4px; }

/* PROFIT ROW */
.profit-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.profit-box { background:var(--surface); border:1px solid var(--border); border-radius:7px; padding:8px 12px; text-align:center; }
.profit-title { font-size:9px; letter-spacing:0.1em; color:var(--muted); margin-bottom:4px; }
.profit-val { font-size:13px; font-weight:600; }

/* CONFIDENCE */
.conf-row { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.conf-label { font-size:9px; letter-spacing:0.12em; color:var(--muted); white-space:nowrap; }
.conf-track { flex:1; height:4px; background:var(--border); border-radius:2px; overflow:hidden; }
.conf-fill { height:100%; border-radius:2px; transition:width 0.5s; }
.conf-pct { font-size:12px; font-weight:600; white-space:nowrap; }

/* SETUP BADGE */
.setup-badges { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
.setup-badge { font-size:10px; padding:5px 12px; border-radius:5px; font-weight:700; letter-spacing:0.06em; }

/* DIVIDER */
.div { border:none; border-top:1px solid var(--border); margin:14px 0; }

/* SECTION */
.sec-title { font-size:9px; letter-spacing:0.14em; color:var(--muted); margin-bottom:8px; }
.reasoning { font-size:12px; color:#8ba8c8; line-height:1.7; }
.session-note { font-size:11px; color:var(--accent); padding:8px 12px; background:rgba(0,212,255,0.04); border:1px solid rgba(0,212,255,0.12); border-radius:6px; margin:10px 0; }

/* KEY LEVELS */
.levels-list { display:flex; flex-wrap:wrap; gap:6px; }
.lv-tag { font-size:10px; padding:4px 10px; border-radius:4px; background:rgba(0,212,255,0.06); border:1px solid var(--border); color:var(--accent); }

/* INVALIDATION */
.invalid-box { font-size:11px; color:var(--warn); margin-top:10px; }

/* TAGS */
.tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
.tag { font-size:9px; padding:3px 9px; border-radius:3px; background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--muted); letter-spacing:0.08em; }

/* TF ALIGNMENT */
.tf-align { font-size:11px; color:#8ba8c8; line-height:1.7; margin-bottom:12px; }

/* BACKTEST BADGE */
.bt-bar { background:rgba(255,215,0,0.06); border:1px solid rgba(255,215,0,0.2); border-radius:7px; padding:7px 14px; font-size:10px; color:var(--gold); letter-spacing:0.1em; text-align:center; margin-bottom:10px; }

/* ERROR */
.error-box { background:rgba(255,68,68,0.08); border:1px solid rgba(255,68,68,0.3); border-radius:10px; padding:16px 20px; font-size:12px; color:var(--red); margin-bottom:12px; }

/* FOOTER */
footer { border-top:1px solid var(--border); padding:20px 0; text-align:center; font-size:10px; color:var(--muted); line-height:1.8; margin-top:10px; }

/* ‚îÄ‚îÄ JOURNAL ‚îÄ‚îÄ */
.journal-section { margin: 30px 0 40px; }
.journal-header {
  display:flex; align-items:center; justify-content:space-between;
  flex-wrap:wrap; gap:10px; margin-bottom:16px;
  padding-bottom:12px; border-bottom:1px solid var(--border);
}
.journal-title { font-family:'Syne',sans-serif; font-weight:800; font-size:16px; letter-spacing:0.05em; }
.journal-title span { color:var(--accent); }
.btn-clear-journal {
  font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.1em;
  padding:5px 12px; border-radius:5px; cursor:pointer; border:1px solid var(--muted);
  color:var(--muted); background:transparent; transition:all 0.2s;
}
.btn-clear-journal:hover { border-color:var(--red); color:var(--red); }

/* STATS BAR */
.stats-bar {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
  gap:8px; margin-bottom:16px;
}
.stat-box {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:10px 14px; text-align:center;
}
.stat-label { font-size:9px; letter-spacing:0.12em; color:var(--muted); margin-bottom:4px; }
.stat-val { font-size:18px; font-weight:700; font-family:'Syne',sans-serif; }
.stat-win { color:var(--green); }
.stat-loss { color:var(--red); }
.stat-miss { color:var(--gold); }
.stat-total { color:var(--accent); }
.stat-rate { color:var(--text); }

/* JOURNAL TABLE */
.journal-table-wrap { overflow-x:auto; }
.journal-table {
  width:100%; border-collapse:collapse; font-size:11px;
}
.journal-table th {
  font-size:9px; letter-spacing:0.12em; color:var(--muted);
  padding:8px 10px; border-bottom:1px solid var(--border);
  text-align:left; white-space:nowrap; background:var(--surface);
}
.journal-table td {
  padding:10px 10px; border-bottom:1px solid rgba(30,45,61,0.6);
  vertical-align:middle; white-space:nowrap;
}
.journal-table tr:hover td { background:rgba(0,212,255,0.02); }
.journal-table tr.outcome-win td { border-left:2px solid var(--green); }
.journal-table tr.outcome-loss td { border-left:2px solid var(--red); }
.journal-table tr.outcome-miss td { border-left:2px solid var(--gold); }
.journal-table tr.outcome-pending td { border-left:2px solid var(--muted); }

/* OUTCOME BUTTONS */
.outcome-btns { display:flex; gap:5px; }
.obtn {
  font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.08em;
  padding:4px 9px; border-radius:4px; cursor:pointer; border:1px solid; 
  background:transparent; transition:all 0.15s; white-space:nowrap;
}
.obtn-win { border-color:rgba(0,255,136,0.35); color:var(--green); }
.obtn-win:hover, .obtn-win.active { background:rgba(0,255,136,0.15); border-color:var(--green); }
.obtn-loss { border-color:rgba(255,68,68,0.35); color:var(--red); }
.obtn-loss:hover, .obtn-loss.active { background:rgba(255,68,68,0.15); border-color:var(--red); }
.obtn-miss { border-color:rgba(255,215,0,0.35); color:var(--gold); }
.obtn-miss:hover, .obtn-miss.active { background:rgba(255,215,0,0.15); border-color:var(--gold); }
.obtn-del { border-color:rgba(74,96,128,0.4); color:var(--muted); font-size:10px; padding:4px 7px; }
.obtn-del:hover { border-color:var(--red); color:var(--red); }

/* DIR MINI BADGES */
.dir-mini { font-size:9px; padding:2px 7px; border-radius:3px; font-weight:700; letter-spacing:0.08em; }
.dir-mini-buy { background:rgba(0,255,136,0.12); color:var(--green); }
.dir-mini-sell { background:rgba(255,68,68,0.12); color:var(--red); }
.dir-mini-other { background:rgba(0,212,255,0.1); color:var(--accent); }

/* CONF MINI */
.conf-mini { font-size:9px; padding:2px 7px; border-radius:3px; }
.conf-strong { background:rgba(0,255,136,0.08); color:var(--green); }
.conf-good { background:rgba(0,212,255,0.08); color:var(--accent); }
.conf-valid { background:rgba(255,215,0,0.08); color:var(--gold); }

.empty-journal { text-align:center; padding:30px; color:var(--muted); font-size:12px; }

/* ACCOUNT TRACKER */
.account-tracker {
  background: var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:16px; margin-bottom:16px;
}
.account-tracker-top {
  display:flex; align-items:center; justify-content:space-between;
  flex-wrap:wrap; gap:10px; margin-bottom:14px;
}
.account-tracker-title { font-size:10px; letter-spacing:0.14em; color:var(--muted); font-weight:700; }
.acct-fields { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
.acct-field label { font-size:9px; letter-spacing:0.1em; color:var(--muted); display:block; margin-bottom:4px; }
.acct-field input {
  width:120px; background:var(--card); border:1px solid var(--border);
  color:var(--text); font-family:'JetBrains Mono',monospace; font-size:12px;
  padding:6px 10px; border-radius:6px;
}
.acct-field input:focus { outline:none; border-color:var(--accent); }
.btn-acct-save {
  font-family:'JetBrains Mono',monospace; font-size:9px; letter-spacing:0.1em;
  padding:7px 14px; border-radius:6px; cursor:pointer;
  border:1px solid var(--accent); color:var(--accent); background:rgba(0,212,255,0.06);
  transition:all 0.2s; white-space:nowrap;
}
.btn-acct-save:hover { background:rgba(0,212,255,0.15); }
.acct-stats {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:8px;
}
.acct-stat { background:var(--card); border:1px solid var(--border); border-radius:7px; padding:8px 12px; }
.acct-stat-label { font-size:9px; letter-spacing:0.1em; color:var(--muted); margin-bottom:3px; }
.acct-stat-val { font-size:15px; font-weight:700; font-family:'Syne',sans-serif; }

/* PASTE ZONE */
.paste-zone {
  border:1.5px dashed rgba(255,215,0,0.3); border-radius:8px;
  padding:12px 16px; margin-bottom:12px;
  background:rgba(255,215,0,0.03); cursor:pointer;
  transition:border-color 0.2s;
}
.paste-zone:focus { outline:none; border-color:var(--gold); }
.paste-zone.pasting { border-color:var(--gold); background:rgba(255,215,0,0.08); }
.paste-zone-top { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.paste-zone-label { font-size:9px; letter-spacing:0.12em; color:var(--gold); font-weight:700; }
.paste-tf-select {
  background:var(--card); border:1px solid var(--border); color:var(--text);
  font-family:'JetBrains Mono',monospace; font-size:10px; padding:4px 8px; border-radius:5px;
}
.paste-hint { font-size:10px; color:var(--muted); margin-left:auto; }
.paste-preview { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.paste-thumb { position:relative; }
.paste-thumb img { height:50px; border-radius:4px; object-fit:cover; border:1px solid var(--border); }
.paste-thumb-label { position:absolute; top:2px; left:2px; font-size:8px; background:rgba(0,0,0,0.7); color:var(--gold); padding:1px 4px; border-radius:2px; }

/* CHART READING VERIFICATION PANEL */
.chart-reading-panel {
  background:var(--card); border:1px solid var(--border); border-radius:10px;
  padding:14px; margin-bottom:14px;
}
.chart-reading-title {
  font-size:9px; letter-spacing:0.14em; color:var(--gold); font-weight:700;
  margin-bottom:10px; display:flex; align-items:center; gap:6px;
}
.chart-reading-title span { color:var(--muted); font-weight:400; }
.chart-reading-grid {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:6px;
}
.cr-box {
  background:var(--surface); border:1px solid var(--border); border-radius:7px;
  padding:8px 10px;
}
.cr-tf {
  font-size:9px; letter-spacing:0.1em; font-weight:700; margin-bottom:5px;
}
.cr-tf.bull { color:var(--green); }
.cr-tf.bear { color:var(--red); }
.cr-tf.neut { color:var(--muted); }
.cr-row { display:flex; justify-content:space-between; font-size:10px; margin-bottom:2px; }
.cr-label { color:var(--muted); }
.cr-val { color:var(--text); font-weight:600; }
.cr-current {
  background:var(--surface); border:1px solid var(--accent); border-radius:7px;
  padding:8px 12px; display:flex; justify-content:space-between; align-items:center;
  margin-bottom:10px;
}
.cr-current-label { font-size:9px; letter-spacing:0.1em; color:var(--accent); }
.cr-current-price { font-size:18px; font-weight:700; color:var(--accent); font-family:'Syne',sans-serif; }

/* SAVE TO JOURNAL BTN */
.save-journal-btn {
  margin-top:10px; width:100%;
  background:rgba(0,255,136,0.06); border:1px solid rgba(0,255,136,0.25);
  color:var(--green); font-family:'JetBrains Mono',monospace; font-size:11px;
  letter-spacing:0.1em; padding:10px; border-radius:8px; cursor:pointer;
  transition:all 0.2s;
}
.save-journal-btn:hover { background:rgba(0,255,136,0.12); border-color:var(--green); }
</style>

</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header>
  <div class="hdr">
    <div class="logo">
      <div class="logo-hex">AC</div>
      <div>
        <div class="logo-text">APEX <span>CORE</span></div>
        <div class="logo-sub">AI FOREX ANALYZER ‚Äî EURUSD ¬∑ XAUUSD</div>
      </div>
    </div>
    <div class="api-row">
      <input class="api-input" id="apiKey" type="password" placeholder="sk-ant-api-key...">
      <button class="btn-save" onclick="saveKey()">SAVE KEY</button>
      <span class="api-ok" id="apiOk">‚óè READY</span>
      <span class="api-err" id="apiErr">‚úï INVALID</span>
    </div>
  </div>
</header>

<!-- SETTINGS -->
<div class="settings-row">
  <div class="field">
    <label>PAIR</label>
    <select id="pair">
      <option value="EUR/USD" selected>EUR/USD</option>
      <option value="XAU/USD">XAU/USD ‚Äî Gold</option>
      <option value="GBP/USD">GBP/USD</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="GBP/JPY">GBP/JPY</option>
      <option value="AUD/USD">AUD/USD</option>
      <option value="USD/CAD">USD/CAD</option>
    </select>
  </div>
  <div class="field">
    <label>BALANCE ($)</label>
    <input type="number" id="balance" value="5000" placeholder="5000">
  </div>
  <div class="field">
    <label>RISK PER TRADE (%)</label>
    <input type="number" id="risk" value="2" min="0.5" max="10" step="0.5">
  </div>
  <div class="field">
    <label>MIN R:R</label>
    <select id="rr">
      <option value="1:3">1:3 minimum</option>
      <option value="1:5" selected>1:5 preferred</option>
      <option value="1:7">1:7 high quality</option>
    </select>
  </div>
  <div class="field">
    <label>NOTES (optional)</label>
    <input type="text" id="notes" placeholder="e.g. NFP day, news event...">
  </div>
</div>

<!-- MODE TOGGLES -->
<div class="modes-row">
  <label class="toggle-btn" id="btToggle" onclick="toggleBT()">
    <input type="checkbox" id="btCheck">
    ‚è™ Backtest Mode
    <span class="badge badge-bt" id="btBadge">BACKTEST</span>
  </label>
  <label class="toggle-btn" id="cfToggle" onclick="toggleCF()">
    <input type="checkbox" id="cfCheck">
    üì∏ Stage 2 ‚Äî Confirm Entry
    <span class="badge badge-cf" id="cfBadge">CONFIRM</span>
  </label>
</div>

<!-- BACKTEST TIME -->
<div id="btTimeRow">
  <div class="field">
    <label style="color:var(--gold);font-size:9px;letter-spacing:0.12em;display:block;margin-bottom:5px">SIMULATED EST TIME</label>
    <select id="btTime">
      <option value="12:00 AM EST ‚Äî London Open" selected>12:00 AM ‚Äî London Open (YOUR SESSION)</option>
      <option value="1:00 AM EST ‚Äî London Session">1:00 AM ‚Äî London Session</option>
      <option value="2:00 AM EST ‚Äî London Mid">2:00 AM ‚Äî London Mid</option>
      <option value="3:00 AM EST ‚Äî London Active">3:00 AM ‚Äî London Active</option>
      <option value="4:00 AM EST ‚Äî London Session">4:00 AM ‚Äî London Session</option>
      <option value="6:00 AM EST ‚Äî London Late">6:00 AM ‚Äî London Late</option>
      <option value="8:00 AM EST ‚Äî NY Open">8:00 AM ‚Äî NY Open</option>
      <option value="9:00 AM EST ‚Äî NY Morning">9:00 AM ‚Äî NY Morning</option>
      <option value="10:00 AM EST ‚Äî NY Session">10:00 AM ‚Äî NY Session</option>
      <option value="12:00 PM EST ‚Äî NY Afternoon">12:00 PM ‚Äî NY Afternoon</option>
      <option value="2:00 PM EST ‚Äî NY Close">2:00 PM ‚Äî NY Close</option>
      <option value="7:00 PM EST ‚Äî Asia Open">7:00 PM ‚Äî Asia Open</option>
    </select>
  </div>
</div>

<!-- UPLOAD ZONES -->
<div class="upload-grid" id="uploadGrid">
  <div class="zone" id="z1W" onclick="document.getElementById('f1W').click()" ondragover="dov(event,'z1W')" ondragleave="dlv('z1W')" ondrop="dop(event,'z1W','f1W')">
    <div class="zone-tf">1W</div><div class="zone-hint">Weekly</div>
    <img id="p1W"><button class="zone-rm" onclick="rm(event,'1W')">‚úï</button>
    <input type="file" id="f1W" accept="image/*" style="display:none" onchange="up(this,'1W')">
  </div>
  <div class="zone" id="z1D" onclick="document.getElementById('f1D').click()" ondragover="dov(event,'z1D')" ondragleave="dlv('z1D')" ondrop="dop(event,'z1D','f1D')">
    <div class="zone-tf">1D</div><div class="zone-hint">Daily</div>
    <img id="p1D"><button class="zone-rm" onclick="rm(event,'1D')">‚úï</button>
    <input type="file" id="f1D" accept="image/*" style="display:none" onchange="up(this,'1D')">
  </div>
  <div class="zone" id="z4H" onclick="document.getElementById('f4H').click()" ondragover="dov(event,'z4H')" ondragleave="dlv('z4H')" ondrop="dop(event,'z4H','f4H')">
    <div class="zone-tf">4H</div><div class="zone-hint">4 Hour</div>
    <img id="p4H"><button class="zone-rm" onclick="rm(event,'4H')">‚úï</button>
    <input type="file" id="f4H" accept="image/*" style="display:none" onchange="up(this,'4H')">
  </div>
  <div class="zone" id="z1H" onclick="document.getElementById('f1H').click()" ondragover="dov(event,'z1H')" ondragleave="dlv('z1H')" ondrop="dop(event,'z1H','f1H')">
    <div class="zone-tf">1H</div><div class="zone-hint">1 Hour</div>
    <img id="p1H"><button class="zone-rm" onclick="rm(event,'1H')">‚úï</button>
    <input type="file" id="f1H" accept="image/*" style="display:none" onchange="up(this,'1H')">
  </div>
  <div class="zone" id="z15M" onclick="document.getElementById('f15M').click()" ondragover="dov(event,'z15M')" ondragleave="dlv('z15M')" ondrop="dop(event,'z15M','f15M')">
    <div class="zone-tf">15M</div><div class="zone-hint">15 Min</div>
    <img id="p15M"><button class="zone-rm" onclick="rm(event,'15M')">‚úï</button>
    <input type="file" id="f15M" accept="image/*" style="display:none" onchange="up(this,'15M')">
  </div>
  <div class="zone" id="z5M" onclick="document.getElementById('f5M').click()" ondragover="dov(event,'z5M')" ondragleave="dlv('z5M')" ondrop="dop(event,'z5M','f5M')">
    <div class="zone-tf">5M</div><div class="zone-hint">5 Min</div>
    <img id="p5M"><button class="zone-rm" onclick="rm(event,'5M')">‚úï</button>
    <input type="file" id="f5M" accept="image/*" style="display:none" onchange="up(this,'5M')">
  </div>
</div>

<!-- PASTE ZONE -->
<div class="paste-zone" id="pasteZone" tabindex="0" onclick="this.focus()">
  <div class="paste-zone-top">
    <div class="paste-zone-label">üìã PASTE IMAGE HERE</div>
    <select class="paste-tf-select" id="pasteTfSelect">
      <option value="1W">1W ‚Äî Weekly</option>
      <option value="1D">1D ‚Äî Daily</option>
      <option value="4H">4H ‚Äî 4 Hour</option>
      <option value="1H">1H ‚Äî 1 Hour</option>
      <option value="15M">15M ‚Äî 15 Min</option>
      <option value="5M" selected>5M ‚Äî 5 Min</option>
      <option value="CF">CONFIRMATION (Stage 2)</option>
    </select>
    <span class="paste-hint">Take screenshot ‚Üí Cmd+V / Ctrl+V here</span>
  </div>
</div>

<!-- CONFIRMATION ZONE -->
<div class="confirm-zone-wrap">
  <div class="confirm-zone-label">üì∏ STAGE 2 ‚Äî CONFIRMATION SCREENSHOT</div>
  <div class="confirm-zone" id="cfZone" onclick="document.getElementById('cfFile').click()" ondragover="event.preventDefault();this.style.borderColor='var(--green)'" ondragleave="this.style.borderColor='rgba(0,255,136,0.3)'" ondrop="cfDrop(event)">
    <img id="cfPrev">
    <span class="confirm-zone-hint" id="cfHint">Drop 5M or 15M confirmation screenshot here</span>
    <button id="cfRm" onclick="cfRemove(event)">‚úï</button>
    <input type="file" id="cfFile" accept="image/*" style="display:none" onchange="cfUp(this)">
  </div>
  <div style="font-size:9px;color:var(--muted);margin-top:6px;text-align:center">Only upload here when the app says "Bring me a confirmation screenshot" ‚Äî then tick Stage 2 above</div>
</div>

<!-- ACTION BUTTONS -->
<div class="action-row">
  <button class="btn-action btn-clear" onclick="clearAll()">üóë CLEAR ALL</button>
  <button class="btn-action btn-clear" onclick="clearResults()">‚úï CLEAR RESULTS</button>
  <button class="btn-action btn-reanalyze" onclick="reAnalyze()">üîÑ RE-ANALYZE</button>
</div>

<!-- ANALYZE -->
<button class="analyze-btn" id="analyzeBtn" onclick="analyze()">
  ‚ö° ANALYZE CHARTS ‚Äî GET TRADE SETUP
</button>
<div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>

<!-- RESULTS -->
<div id="results"></div>

<!-- ‚îÄ‚îÄ TRADE JOURNAL ‚îÄ‚îÄ -->
<div class="journal-section">
  <div class="journal-header">
    <div class="journal-title">TRADE <span>JOURNAL</span></div>
    <button class="btn-clear-journal" onclick="clearJournal()">üóë CLEAR ALL RECORDS</button>
  </div>

  <!-- ACCOUNT TRACKER -->
  <div class="account-tracker">
    <div class="account-tracker-top">
      <div class="account-tracker-title">üí∞ ACCOUNT TRACKER</div>
      <div class="acct-fields">
        <div class="acct-field">
          <label>STARTING BALANCE ($)</label>
          <input type="number" id="startBalance" value="1500" placeholder="1500">
        </div>
        <div class="acct-field">
          <label>RISK PER TRADE (%)</label>
          <input type="number" id="riskPct" value="2" min="0.1" max="10" step="0.1" placeholder="2">
        </div>
        <button class="btn-acct-save" onclick="saveAccountSettings()">SAVE SETTINGS</button>
      </div>
    </div>
    <div class="acct-stats">
      <div class="acct-stat"><div class="acct-stat-label">STARTING BALANCE</div><div class="acct-stat-val" id="ac-start" style="color:var(--muted)">$1,500</div></div>
      <div class="acct-stat"><div class="acct-stat-label">CURRENT BALANCE</div><div class="acct-stat-val" id="ac-current" style="color:var(--accent)">$1,500</div></div>
      <div class="acct-stat"><div class="acct-stat-label">RISK PER TRADE</div><div class="acct-stat-val" id="ac-risk" style="color:var(--warn)">$30</div></div>
      <div class="acct-stat"><div class="acct-stat-label">TOTAL P&L</div><div class="acct-stat-val" id="ac-pnl" style="color:var(--muted)">$0</div></div>
      <div class="acct-stat"><div class="acct-stat-label">TOTAL GAINED</div><div class="acct-stat-val" id="ac-gained" style="color:var(--green)">$0</div></div>
      <div class="acct-stat"><div class="acct-stat-label">TOTAL LOST</div><div class="acct-stat-val" id="ac-lost" style="color:var(--red)">$0</div></div>
      <div class="acct-stat"><div class="acct-stat-label">ACCOUNT GROWTH</div><div class="acct-stat-val" id="ac-growth" style="color:var(--muted)">0%</div></div>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat-box"><div class="stat-label">TOTAL TRADES</div><div class="stat-val stat-total" id="st-total">0</div></div>
    <div class="stat-box"><div class="stat-label">WINS</div><div class="stat-val stat-win" id="st-win">0</div></div>
    <div class="stat-box"><div class="stat-label">LOSSES</div><div class="stat-val stat-loss" id="st-loss">0</div></div>
    <div class="stat-box"><div class="stat-label">MISSED</div><div class="stat-val stat-miss" id="st-miss">0</div></div>
    <div class="stat-box"><div class="stat-label">WIN RATE</div><div class="stat-val stat-rate" id="st-rate">‚Äî</div></div>
    <div class="stat-box"><div class="stat-label">PENDING</div><div class="stat-val" style="color:var(--muted)" id="st-pend">0</div></div>
  </div>

  <div class="journal-table-wrap">
    <table class="journal-table">
      <thead><tr><th>#</th><th>DATE / TIME</th><th>PAIR</th><th>DIR</th><th>ENTRY</th><th>SL</th><th>TP1</th><th>TP2</th><th>R:R</th><th>RISK $</th><th>P&L $</th><th>CONFIDENCE</th><th>OUTCOME</th><th></th></tr></thead>
      <tbody id="journalBody"><tr><td colspan="14" class="empty-journal">No trades recorded yet ‚Äî run an analysis and save it to the journal</td></tr></tbody>
    </table>
  </div>
</div>
<footer>APEX CORE ‚Äî AI Forex Analyzer ¬∑ Powered by Claude AI<br>For educational use only ¬∑ Always trade with proper risk management</footer>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const imgs = {};
let cfImg = null;
let savedKey = localStorage.getItem('apexKey') || '';

// Pre-fill key
if (savedKey) { document.getElementById('apiKey').value = savedKey; showKeyOk(); }

// Auto-select closest EST time ‚Äî defaults to London Open (midnight EST = your session)
(function(){
  const h = new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'})).getHours();
  const opts = [
    {h:0,v:'12:00 AM EST ‚Äî London Open'},
    {h:1,v:'1:00 AM EST ‚Äî London Session'},
    {h:2,v:'2:00 AM EST ‚Äî London Mid'},
    {h:3,v:'3:00 AM EST ‚Äî London Active'},
    {h:4,v:'4:00 AM EST ‚Äî London Session'},
    {h:6,v:'6:00 AM EST ‚Äî London Late'},
    {h:8,v:'8:00 AM EST ‚Äî NY Open'},
    {h:9,v:'9:00 AM EST ‚Äî NY Morning'},
    {h:10,v:'10:00 AM EST ‚Äî NY Session'},
    {h:12,v:'12:00 PM EST ‚Äî NY Afternoon'},
    {h:14,v:'2:00 PM EST ‚Äî NY Close'},
    {h:19,v:'7:00 PM EST ‚Äî Asia Open'}
  ];
  let best=opts[0], diff=99;
  opts.forEach(o=>{ const d=Math.abs(h-o.h); if(d<diff){diff=d;best=o;} });
  document.getElementById('btTime').value = best.v;
})();

// ‚îÄ‚îÄ KEY ‚îÄ‚îÄ
function saveKey(){
  const k = document.getElementById('apiKey').value.trim();
  if(!k.startsWith('sk-ant')){ showKeyErr(); return; }
  savedKey = k;
  localStorage.setItem('apexKey', k);
  showKeyOk();
}
function showKeyOk(){ document.getElementById('apiOk').style.display='inline'; document.getElementById('apiErr').style.display='none'; }
function showKeyErr(){ document.getElementById('apiErr').style.display='inline'; document.getElementById('apiOk').style.display='none'; }

// ‚îÄ‚îÄ TOGGLES ‚îÄ‚îÄ
function toggleBT(){
  const on = !document.getElementById('btCheck').checked;
  document.getElementById('btCheck').checked = on;
  document.getElementById('btToggle').className = 'toggle-btn' + (on?' active-backtest':'');
  document.getElementById('btBadge').style.display = on?'inline':'none';
  document.getElementById('btTimeRow').style.display = on?'block':'none';
}
function toggleCF(){
  const on = !document.getElementById('cfCheck').checked;
  document.getElementById('cfCheck').checked = on;
  document.getElementById('cfToggle').className = 'toggle-btn' + (on?' active-confirm':'');
  document.getElementById('cfBadge').style.display = on?'inline':'none';
}

// ‚îÄ‚îÄ UPLOAD ZONES ‚îÄ‚îÄ
function up(input, tf){
  const file = input.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    imgs[tf] = e.target.result;
    const z = document.getElementById('z'+tf);
    const p = document.getElementById('p'+tf);
    z.classList.add('has-img');
    p.src = e.target.result; p.style.display='block';
  };
  r.readAsDataURL(file);
}
function rm(e, tf){
  e.stopPropagation();
  delete imgs[tf];
  document.getElementById('z'+tf).classList.remove('has-img');
  const p = document.getElementById('p'+tf);
  p.src=''; p.style.display='none';
  document.getElementById('f'+tf).value='';
}
function dov(e, zid){ e.preventDefault(); document.getElementById(zid).style.borderColor='var(--accent)'; }
function dlv(zid){ document.getElementById(zid).style.borderColor=''; }
function dop(e, zid, fid){
  e.preventDefault(); dlv(zid);
  const file = e.dataTransfer.files[0];
  if(!file||!file.type.startsWith('image/')) return;
  const inp = document.getElementById(fid);
  const dt = new DataTransfer(); dt.items.add(file); inp.files = dt.files;
  up(inp, zid.replace('z',''));
}

// ‚îÄ‚îÄ PASTE SUPPORT ‚îÄ‚îÄ
function loadImageFromFile(file, tf){
  if(!file || !file.type.startsWith('image/')) return;
  const r = new FileReader();
  r.onload = e => {
    if(tf === 'CF'){
      cfImg = e.target.result;
      document.getElementById('cfPrev').src = cfImg;
      document.getElementById('cfPrev').style.display='block';
      document.getElementById('cfHint').style.display='none';
      document.getElementById('cfRm').style.display='flex';
      document.getElementById('cfZone').style.borderColor='var(--green)';
      if(!document.getElementById('cfCheck').checked) toggleCF();
    } else {
      imgs[tf] = e.target.result;
      const z = document.getElementById('z'+tf);
      const p = document.getElementById('p'+tf);
      z.classList.add('has-img');
      p.src = e.target.result; p.style.display='block';
    }
    // Flash paste zone green
    const pz = document.getElementById('pasteZone');
    pz.style.borderColor='var(--green)';
    pz.style.background='rgba(0,255,136,0.06)';
    setTimeout(()=>{ pz.style.borderColor=''; pz.style.background=''; }, 1000);
  };
  r.readAsDataURL(file);
}

// Listen for paste anywhere on the page
document.addEventListener('paste', function(e){
  const items = e.clipboardData?.items;
  if(!items) return;
  for(let i=0; i<items.length; i++){
    if(items[i].type.startsWith('image/')){
      const file = items[i].getAsFile();
      const tf = document.getElementById('pasteTfSelect').value;
      loadImageFromFile(file, tf);
      // Auto-advance timeframe selector after paste
      const sel = document.getElementById('pasteTfSelect');
      const opts = ['1W','1D','4H','1H','15M','5M','CF'];
      const idx = opts.indexOf(sel.value);
      if(idx < opts.length-1) sel.value = opts[idx+1];
      break;
    }
  }
});

// Also paste on the paste zone click focus
document.getElementById('pasteZone').addEventListener('keydown', function(e){
  if((e.ctrlKey||e.metaKey) && e.key==='v'){
    // Handled by the global paste listener above
  }
});
function cfUp(input){
  const file = input.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    cfImg = e.target.result;
    document.getElementById('cfPrev').src = cfImg;
    document.getElementById('cfPrev').style.display='block';
    document.getElementById('cfHint').style.display='none';
    document.getElementById('cfRm').style.display='flex';
    document.getElementById('cfZone').style.borderColor='var(--green)';
    // Auto-enable stage 2
    if(!document.getElementById('cfCheck').checked) toggleCF();
  };
  r.readAsDataURL(file);
}
function cfDrop(e){
  e.preventDefault();
  document.getElementById('cfZone').style.borderColor='rgba(0,255,136,0.3)';
  const file = e.dataTransfer.files[0];
  if(!file||!file.type.startsWith('image/')) return;
  const inp = document.getElementById('cfFile');
  const dt = new DataTransfer(); dt.items.add(file); inp.files = dt.files;
  cfUp(inp);
}
function cfRemove(e){
  e.stopPropagation();
  cfImg=null;
  document.getElementById('cfPrev').src=''; document.getElementById('cfPrev').style.display='none';
  document.getElementById('cfHint').style.display='block';
  document.getElementById('cfRm').style.display='none';
  document.getElementById('cfZone').style.borderColor='rgba(0,255,136,0.3)';
  document.getElementById('cfFile').value='';
}

// ‚îÄ‚îÄ CLEAR / REANALYZE ‚îÄ‚îÄ
function clearAll(){
  ['1W','1D','4H','1H','15M','5M'].forEach(tf=>{
    delete imgs[tf];
    document.getElementById('z'+tf).classList.remove('has-img');
    const p=document.getElementById('p'+tf); p.src=''; p.style.display='none';
    document.getElementById('f'+tf).value='';
  });
  cfRemove({stopPropagation:()=>{}});
  clearResults();
}
function clearResults(){ document.getElementById('results').innerHTML=''; }
function reAnalyze(){ document.getElementById('results').innerHTML=''; analyze(); }

// ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ
async function analyze(){
  const key = document.getElementById('apiKey').value.trim() || savedKey;
  if(!key||!key.startsWith('sk-ant')){ alert('Please enter and save your Anthropic API key.'); return; }
  if(!Object.keys(imgs).length && !cfImg){ alert('Please upload at least one chart screenshot.'); return; }

  const btn = document.getElementById('analyzeBtn');
  const bar = document.getElementById('loadBar');
  btn.disabled=true; btn.textContent='‚è≥ ANALYZING‚Ä¶'; bar.classList.add('active');

  const pair = document.getElementById('pair').value;
  const balance = document.getElementById('balance').value;
  const risk = document.getElementById('risk').value;
  const rr = document.getElementById('rr').value;
  const notes = document.getElementById('notes').value;
  const isBT = document.getElementById('btCheck').checked;
  const isCF = document.getElementById('cfCheck').checked;
  const btTime = document.getElementById('btTime').value;
  const now = isBT ? btTime+' (BACKTEST)' : new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour12:true});

  // Build content
  const content = [];
  ['1W','1D','4H','1H','15M','5M'].forEach(tf=>{
    if(imgs[tf]){
      content.push({type:'text',text:`[${tf} TIMEFRAME CHART ‚Äî includes EMA 20/50/100/200, Volume, RSI 14]:`});
      content.push({type:'image',source:{type:'base64',media_type:imgs[tf].split(';')[0].replace('data:',''),data:imgs[tf].split(',')[1]}});
    }
  });
  if(isCF && cfImg){
    content.push({type:'text',text:`[CONFIRMATION SCREENSHOT ‚Äî Stage 2 candle check]:`});
    content.push({type:'image',source:{type:'base64',media_type:cfImg.split(';')[0].replace('data:',''),data:cfImg.split(',')[1]}});
  }

  const sysPrompt = `You are APEX CORE ‚Äî a professional forex trading analysis system for ${pair}.

YOUR ROLE: You are an ANALYST only. Never tell the trader to enter directly. Guide them through a 2-stage confirmation process.

INDICATORS ON CHARTS: Each chart includes EMA 20 (orange/fast), EMA 50 (blue/medium), EMA 100 (purple), EMA 200 (red/slow), Volume bars, and RSI 14. Use ALL of these in your analysis.

EMA RULES:
- Price below EMA 200 ‚Üí only consider SELLS
- Price above EMA 200 ‚Üí only consider BUYS  
- EMA 20 crossing below EMA 50 ‚Üí bearish momentum confirmed
- EMA 20 crossing above EMA 50 ‚Üí bullish momentum confirmed
- All EMAs sloping same direction ‚Üí strong trend confirmation
- Price bouncing off EMA 100 ‚Üí dynamic support/resistance

RSI RULES:
- RSI above 70 at resistance ‚Üí overbought, strong SELL signal
- RSI below 30 at support ‚Üí oversold, strong BUY signal
- RSI divergence (price makes new high but RSI doesn't) ‚Üí reversal warning
- RSI between 40-60 ‚Üí no strong signal, wait for extremes

VOLUME RULES:
- High volume on bearish candle at resistance ‚Üí institutional selling confirmed
- High volume on bullish candle at support ‚Üí institutional buying confirmed
- Low volume on move ‚Üí weak signal, wait for volume confirmation

TOP-DOWN ANALYSIS ORDER: Weekly ‚Üí Daily ‚Üí 4H ‚Üí 1H ‚Üí 15M ‚Üí 5M

TRADE VALIDITY:
- 5/5 timeframes aligned = STRONG (85-95% confidence) ‚Üí SL 60-100 pips from 4H swing
- 4/5 timeframes aligned = GOOD (70-84% confidence) ‚Üí SL 40-70 pips from 1H swing
- 3/5 timeframes aligned = VALID (55-69% confidence) ‚Üí SL 20-40 pips from 15M swing
- Below 3/5 = NO TRADE

ENTRY RULES ‚Äî must be ONE of:
1. Rejection candle at key level (wick + close away from level)
2. Bullish/bearish engulfing at structure
3. Market Structure Shift (MSS) ‚Äî new higher high in downtrend or lower low in uptrend
4. Fair Value Gap (FVG) fill + rejection
5. Liquidity sweep ‚Äî price grabs highs/lows then reverses
6. EMA 200 bounce with RSI confirmation

KEY LEVEL RULES:
- Level must have been tested minimum 2 times to be valid
- Daily/Weekly S&R zones, previous swing highs/lows, round numbers, FVG zones, liquidity pools
- Never trade mid-range ‚Äî only at key levels

ENTRY TYPE:
- TYPE 1 IMMEDIATE: 4+ TFs aligned + strong momentum ‚Üí entry at CURRENT price ¬± 5-10 pips
- TYPE 2 RETEST: 3 TFs aligned or moderate momentum ‚Üí wait for pullback to nearest key level

SL PLACEMENT:
- Always place beyond a structural level (swing high/low), never at round numbers
- Add 5-10 pips buffer beyond the structural level

‚õî HARD RULE ‚Äî MINIMUM R:R ‚Äî NON NEGOTIABLE ‚Äî NO EXCEPTIONS:
- You MUST calculate the R:R to TP2 BEFORE outputting any result
- If R:R to TP2 is below 1:3 ‚Üí you MUST output NO TRADE. Period.
- This rule CANNOT be overridden by strong confluence, high confidence, or good setup quality
- A 1:2 R:R is NOT acceptable even with 5/5 timeframes aligned
- A 1:2.5 R:R is NOT acceptable even with perfect entry signal
- Only R:R of 1:3 or higher qualifies as a valid trade
- If levels do not give 1:3 ‚Üí output NO TRADE and explain the levels don't offer enough reward
- TP1 must be at least 1:1.5 R:R minimum ‚Äî if TP1 is closer than 1.5x the SL distance ‚Üí the setup is weak
- CALCULATE FIRST, DECIDE SECOND ‚Äî never confirm an entry without verifying R:R meets minimum

TP PLACEMENT:
- TP1 = nearest key S/R level (partial profit) ‚Äî must be minimum 1.5x SL distance
- TP2 = next major level (full target) ‚Äî must be minimum 3x SL distance
- Minimum RR: ${rr}
- If natural TP levels don't meet minimum RR ‚Üí NO TRADE, do not force levels

STRATEGY CONFLUENCE (check all that apply):
- ICT/SMC: Liquidity sweep + order block + FVG
- Price Action: Rejection candle + structure
- Support/Resistance: Level tested 2+ times
- Trend Following: EMA alignment + slope direction
- Fibonacci: 50-61.8% retracement zone + key level = higher probability

SESSION RULES:
- London (2AM-8AM EST) + NY (8AM-5PM EST) = valid sessions for entries
- Asia session = low volume, avoid new entries unless very clear setup
- NY Open (8-10AM EST) = highest probability for momentum moves

‚õî HARD RULE ‚Äî NEWS EVENTS ‚Äî NON NEGOTIABLE:
- NEVER confirm a trade entry within 24 hours of a major news event
- Major news = NFP (Non-Farm Payrolls), CPI, Fed Rate Decision, Presidential Elections, GDP, FOMC
- If a major news event is due within 24 hours ‚Üí output WAIT or NO TRADE and warn the trader
- News events cause fake moves that invalidate all technical analysis
- A perfect technical setup is worthless if a news event can wipe it instantly

2-STAGE PROCESS:

STAGE 1 ‚Äî INITIAL ANALYSIS:
Determine ONE outcome:

A) NO TRADE: <3 TFs agree, price mid-range, no key level nearby
   ‚Üí Do NOT give entry/SL/TP figures. Explain what's missing. Give N/A for all levels.

B) WAIT: Setup forming but price not at key level yet
   ‚Üí Do NOT give entry/SL/TP figures. Give N/A. Tell EXACT price level to watch and EXACT expiry time (30-90 mins intraday, up to 4H for swing). If price is already within 10 pips of the zone ‚Üí use NEEDS CONFIRMATION instead.

C) NEEDS CONFIRMATION: 3+ TFs aligned, price AT or within 10 pips of key level
   ‚Üí Give FULL entry/SL/TP/RR figures. Tell trader to bring 5M confirmation screenshot within 15-30 mins.

STAGE 2 ‚Äî CONFIRMATION (when confirmation screenshot provided):
Look ONLY at the confirmation candle. Do NOT re-analyze all timeframes.
- CONFIRMED: Clean trigger candle (rejection wick, engulfing, MSS) ‚Üí Give entry/SL/TP/RR. Say "Place your [BUY/SELL] at [price]"
- NOT YET: Candle still forming or unclear ‚Üí Give N/A figures. Say what to wait for, give 15-30 min new window.
- CANCELLED: Structure changed ‚Üí Give N/A figures. Explain why clearly.

TRADE CONTEXT:
- Pair: ${pair}
- Balance: $${balance}
- Risk per trade: ${risk}%
- Minimum RR: ${rr}
- Current time: ${now}
- Mode: ${isBT ? 'BACKTEST ‚Äî treat simulated time as real, no session timing penalties' : 'LIVE'}
- Stage: ${isCF ? 'STAGE 2 ‚Äî CONFIRMATION. Only check the confirmation candle. Do not ask for more charts.' : 'STAGE 1 ‚Äî INITIAL ANALYSIS'}
- Extra context: ${notes || 'none'}

CRITICAL OUTPUT RULE: Respond ONLY with valid JSON. No markdown, no prose outside JSON.

JSON FORMAT:
{
  "pair": "${pair}",
  "chart_reading": {
    "current_price": "exact current price you see on charts",
    "1W": {"high": "weekly high price", "low": "weekly low price", "close": "weekly close/current price", "bias": "BULLISH/BEARISH/NEUTRAL"},
    "1D": {"high": "daily high price", "low": "daily low price", "close": "daily close/current price", "bias": "BULLISH/BEARISH/NEUTRAL"},
    "4H": {"high": "4H candle high", "low": "4H candle low", "close": "4H current price", "bias": "BULLISH/BEARISH/NEUTRAL"},
    "1H": {"high": "1H candle high", "low": "1H candle low", "close": "1H current price", "bias": "BULLISH/BEARISH/NEUTRAL"},
    "15M": {"high": "15M candle high", "low": "15M candle low", "close": "15M current price", "bias": "BULLISH/BEARISH/NEUTRAL"},
    "5M": {"high": "5M candle high", "low": "5M candle low", "close": "5M current price", "bias": "BULLISH/BEARISH/NEUTRAL"}
  },
  "direction": "BUY" or "SELL" or "NO TRADE" or "WAIT" or "NEEDS CONFIRMATION" or "CONFIRMED" or "NOT YET" or "CANCELLED",
  "entry_zone": "price range or N/A",
  "entry_type": "Market" or "Limit" or "N/A",
  "stop_loss": "price or N/A",
  "sl_pips": number or 0,
  "take_profit_1": "price or N/A",
  "tp1_pips": number or 0,
  "take_profit_2": "price or N/A",
  "tp2_pips": number or 0,
  "rr_ratio": "1:X or N/A",
  "confidence": 0-100,
  "confidence_label": "STRONG" or "GOOD" or "VALID" or "NO TRADE",
  "timeframes_aligned": "X out of 5",
  "setup_type": "TYPE 1 - Immediate" or "TYPE 2 - Retest" or "N/A",
  "ema_reading": "brief note on EMA alignment and price position relative to EMAs",
  "rsi_reading": "RSI value and what it signals",
  "volume_reading": "volume confirmation or lack thereof",
  "timeframe_alignment": "one line per timeframe showing direction and reason",
  "entry_reason": "which entry rule triggered",
  "reasoning": "3-5 sentences ‚Äî reference EMAs, RSI, volume, price action, key levels, structure",
  "session_note": "session timing comment",
  "key_levels": ["level with label"],
  "invalidation": "exact price and reason",
  "timing": "when to expect trigger",
  "risk_amount": dollar number,
  "potential_profit_tp1": dollar number,
  "potential_profit_tp2": dollar number,
  "next_action": "exact instruction for trader",
  "expiry_time": "time window or N/A",
  "tags": ["tag1","tag2","tag3"]
}`;

  content.push({type:'text', text: sysPrompt});

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key': key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body: JSON.stringify({
        model:'claude-opus-4-6',
        max_tokens:2000,
        messages:[{role:'user',content}]
      })
    });
    if(!res.ok){ const e=await res.json(); throw new Error(e.error?.message||`API error ${res.status}`); }
    const data = await res.json();
    const raw = data.content[0].text.trim();
    let result;
    try { result = JSON.parse(raw.replace(/```json|```/g,'').trim()); }
    catch(e){ throw new Error('Could not parse AI response ‚Äî please try again.'); }
    showResult(result);
  } catch(err){
    document.getElementById('results').innerHTML = `<div class="error-box"><strong>‚ö† Error</strong><br><br>${err.message}<br><br><span style="color:var(--muted)">Check your API key has credit and your screenshots are clear TradingView charts.</span></div>`;
  }

  btn.disabled=false; btn.textContent='‚ö° ANALYZE CHARTS ‚Äî GET TRADE SETUP'; bar.classList.remove('active');
}

// ‚îÄ‚îÄ DISPLAY RESULT ‚îÄ‚îÄ
function showResult(r){
  const isBT = document.getElementById('btCheck').checked;
  const btTime = document.getElementById('btTime').value;
  const now = isBT ? btTime+' (BACKTEST)' : new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour12:true});

  const isBuy = ['BUY','CONFIRMED'].includes(r.direction);
  const isSell = ['SELL','CANCELLED'].includes(r.direction);
  const rhClass = isBuy?'rh-buy':isSell?'rh-sell':'rh-neutral';

  const dirDisplay = {
    'NEEDS CONFIRMATION':'üì∏ NEEDS CONFIRMATION',
    'WAIT':'‚è≥ WAIT FOR SETUP',
    'CONFIRMED':'‚úÖ CONFIRMED ‚Äî ENTER',
    'CANCELLED':'‚ùå CANCELLED',
    'NOT YET':'‚è≥ NOT YET',
    'NO TRADE':'‚Äî NO TRADE'
  }[r.direction] || r.direction;

  const dirClass = isBuy?'dir-buy':isSell?'dir-sell':'dir-wait';
  const confColor = r.confidence>=70?'var(--green)':r.confidence>=50?'var(--gold)':'var(--red)';
  const rrNum = parseFloat((r.rr_ratio||'0').split(':')[1]||0);
  const rrColor = rrNum>=10?'var(--gold)':rrNum>=5?'var(--green)':'var(--muted)';

  const setupIcon = {'STRONG':'üî•','GOOD':'‚ö°','VALID':'‚úÖ'}[r.confidence_label]||'';
  const setupColor = {'STRONG':'var(--green)','GOOD':'var(--accent)','VALID':'var(--gold)'}[r.confidence_label]||'var(--muted)';
  const setupBg = {'STRONG':'rgba(0,255,136,0.08)','GOOD':'rgba(0,212,255,0.08)','VALID':'rgba(255,215,0,0.08)'}[r.confidence_label]||'transparent';
  const setupBorder = {'STRONG':'rgba(0,255,136,0.25)','GOOD':'rgba(0,212,255,0.25)','VALID':'rgba(255,215,0,0.25)'}[r.confidence_label]||'var(--border)';

  const hasLevels = r.entry_zone && r.entry_zone !== 'N/A';

  const cr = r.chart_reading || {};
  const tfs = ['1W','1D','4H','1H','15M','5M'];
  const tfLabels = {'1W':'Weekly','1D':'Daily','4H':'4 Hour','1H':'1 Hour','15M':'15 Min','5M':'5 Min'};

  const crPanel = `
  <div class="chart-reading-panel">
    <div class="chart-reading-title">üìä CHART READING VERIFICATION <span>‚Äî confirm AI read your charts correctly</span></div>
    <div class="cr-current">
      <div class="cr-current-label">CURRENT PRICE</div>
      <div class="cr-current-price">${cr.current_price || '‚Äî'}</div>
    </div>
    <div class="chart-reading-grid">
      ${tfs.map(tf => {
        const d = cr[tf] || {};
        const biasClass = d.bias==='BULLISH'?'bull':d.bias==='BEARISH'?'bear':'neut';
        const biasIcon = d.bias==='BULLISH'?'‚ñ≤':d.bias==='BEARISH'?'‚ñº':'‚Äî';
        return `<div class="cr-box">
          <div class="cr-tf ${biasClass}">${tf} ‚Äî ${tfLabels[tf]} ${biasIcon}</div>
          <div class="cr-row"><span class="cr-label">High</span><span class="cr-val">${d.high||'‚Äî'}</span></div>
          <div class="cr-row"><span class="cr-label">Low</span><span class="cr-val">${d.low||'‚Äî'}</span></div>
          <div class="cr-row"><span class="cr-label">Close</span><span class="cr-val">${d.close||'‚Äî'}</span></div>
        </div>`;
      }).join('')}
    </div>
  </div>`;

  const html = `
  ${isBT?`<div class="bt-bar">‚è™ BACKTEST MODE ‚Äî ${btTime}</div>`:''}
  ${crPanel}
  <div class="result-card">
    <div class="rh ${rhClass}">
      <div>
        <div class="rh-pair">${r.pair}</div>
        <div class="rh-time">${now}</div>
      </div>
      <div style="text-align:right">
        <div class="dir-badge ${dirClass}">${dirDisplay}</div>
        <div class="rr-tag" style="color:${rrColor}">R:R ${r.rr_ratio}${rrNum>=10?' üèÜ':rrNum>=5?' ‚ö°':''}</div>
      </div>
    </div>
    <div class="rb">

      ${r.next_action?`
      <div class="next-action">
        <div class="na-top">
          <div class="na-label">‚ö° NEXT ACTION</div>
          ${r.expiry_time&&r.expiry_time!=='N/A'?`<div class="expiry-badge">‚è± EXPIRES: ${r.expiry_time}</div>`:''}
        </div>
        <div class="na-text">${r.next_action}</div>
      </div>`:''}

      ${hasLevels?`
      <div class="lvl-grid">
        <div class="lvl-box"><div class="lvl-title">ENTRY ZONE</div><div class="lvl-val lvl-entry">${r.entry_zone}</div></div>
        <div class="lvl-box"><div class="lvl-title">STOP LOSS</div><div class="lvl-val lvl-sl">${r.stop_loss}<span class="lvl-sub">${r.sl_pips} pips</span></div></div>
        <div class="lvl-box"><div class="lvl-title">TAKE PROFIT 1</div><div class="lvl-val lvl-tp1">${r.take_profit_1}<span class="lvl-sub">${r.tp1_pips} pips</span></div></div>
        <div class="lvl-box"><div class="lvl-title">TAKE PROFIT 2</div><div class="lvl-val lvl-tp2">${r.take_profit_2}<span class="lvl-sub">${r.tp2_pips} pips</span></div></div>
      </div>
      <div class="profit-row">
        <div class="profit-box"><div class="profit-title">RISK</div><div class="profit-val" style="color:var(--red)">$${(r.risk_amount||0).toFixed(0)}</div></div>
        <div class="profit-box"><div class="profit-title">PROFIT @ TP1</div><div class="profit-val lvl-tp1">$${(r.potential_profit_tp1||0).toFixed(0)}</div></div>
        <div class="profit-box"><div class="profit-title">PROFIT @ TP2</div><div class="profit-val lvl-tp2">$${(r.potential_profit_tp2||0).toFixed(0)}</div></div>
      </div>`:''}

      <div class="conf-row">
        <span class="conf-label">CONFIDENCE</span>
        <div class="conf-track"><div class="conf-fill" style="width:${r.confidence}%;background:${confColor}"></div></div>
        <span class="conf-pct" style="color:${confColor}">${r.confidence}%</span>
      </div>

      ${r.confidence_label&&r.confidence_label!=='NO TRADE'?`
      <div class="setup-badges">
        <div class="setup-badge" style="background:${setupBg};color:${setupColor};border:1px solid ${setupBorder}">${setupIcon} ${r.confidence_label} SETUP</div>
        ${r.timeframes_aligned?`<div class="setup-badge" style="background:rgba(0,212,255,0.06);color:var(--accent);border:1px solid rgba(0,212,255,0.15)">üìä ${r.timeframes_aligned} aligned</div>`:''}
        ${r.setup_type&&r.setup_type!=='N/A'?`<div class="setup-badge" style="background:rgba(255,255,255,0.03);color:var(--muted);border:1px solid var(--border)">${r.setup_type}</div>`:''}
      </div>`:''}

      <hr class="div">

      ${r.timeframe_alignment?`<div class="sec-title">TIMEFRAME ALIGNMENT</div><div class="tf-align">${r.timeframe_alignment}</div>`:''}

      ${r.ema_reading||r.rsi_reading||r.volume_reading?`
      <div class="sec-title">INDICATOR READINGS</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:14px">
        ${r.ema_reading?`<div style="background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:10px 12px"><div style="font-size:9px;letter-spacing:0.1em;color:var(--muted);margin-bottom:4px">EMA 20/50/100/200</div><div style="font-size:11px;color:var(--text)">${r.ema_reading}</div></div>`:''}
        ${r.rsi_reading?`<div style="background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:10px 12px"><div style="font-size:9px;letter-spacing:0.1em;color:var(--muted);margin-bottom:4px">RSI 14</div><div style="font-size:11px;color:var(--text)">${r.rsi_reading}</div></div>`:''}
        ${r.volume_reading?`<div style="background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:10px 12px"><div style="font-size:9px;letter-spacing:0.1em;color:var(--muted);margin-bottom:4px">VOLUME</div><div style="font-size:11px;color:var(--text)">${r.volume_reading}</div></div>`:''}
      </div>`:''}

      <div class="sec-title">ANALYSIS</div>
      <div class="reasoning">${r.reasoning}</div>

      ${r.entry_reason&&r.entry_reason!=='N/A'?`<div style="margin-top:10px;font-size:11px;color:var(--green)">‚úì ${r.entry_reason}</div>`:''}
      ${r.session_note?`<div class="session-note">üìç ${r.session_note}</div>`:''}

      <hr class="div">

      ${r.key_levels?.length?`
      <div class="sec-title">KEY LEVELS</div>
      <div class="levels-list">${r.key_levels.map(l=>`<span class="lv-tag">${l}</span>`).join('')}</div>`:''}

      ${r.invalidation?`<div class="invalid-box" style="margin-top:10px">‚ö† Invalidation: ${r.invalidation}</div>`:''}

      <div class="tags">${(r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>

    </div>
  </div>`;

  // Store last result for journal saving
  window._lastResult = r;
  window._lastResultTime = now;

  const res = document.getElementById('results');
  res.innerHTML = `<button class="clear-btn" onclick="clearResults()">‚úï Clear Results</button>` + html + `
  <button class="save-journal-btn" onclick="saveToJournal()">üìã SAVE THIS SUGGESTION TO JOURNAL</button>`;
  res.scrollIntoView({behavior:'smooth',block:'start'});
}

// ‚îÄ‚îÄ JOURNAL ‚îÄ‚îÄ
function loadJournal(){
  try { return JSON.parse(localStorage.getItem('apexJournal') || '[]'); }
  catch(e){ return []; }
}
function saveJournalData(data){
  localStorage.setItem('apexJournal', JSON.stringify(data));
}
function loadAccountSettings(){
  try { return JSON.parse(localStorage.getItem('apexAccount') || '{"balance":1500,"risk":2}'); }
  catch(e){ return {balance:1500,risk:2}; }
}
function saveAccountSettings(){
  const balance = parseFloat(document.getElementById('startBalance').value) || 1500;
  const risk = parseFloat(document.getElementById('riskPct').value) || 2;
  localStorage.setItem('apexAccount', JSON.stringify({balance, risk}));
  // Also update the settings panel balance and risk
  document.getElementById('balance').value = balance;
  document.getElementById('risk').value = risk;
  renderJournal();
}

function getRiskAmount(balance, riskPct){
  return (balance * riskPct / 100);
}

function saveToJournal(){
  const r = window._lastResult;
  if(!r){ alert('No analysis to save.'); return; }
  const acct = loadAccountSettings();
  const riskAmt = getRiskAmount(acct.balance, acct.risk);
  const rrNum = parseFloat((r.rr_ratio||'0').split(':')[1]||0);

  const journal = loadJournal();
  const entry = {
    id: Date.now(),
    timestamp: window._lastResultTime || new Date().toLocaleString('en-US',{timeZone:'America/New_York',hour12:true}),
    pair: r.pair,
    direction: r.direction,
    entry_zone: r.entry_zone,
    stop_loss: r.stop_loss,
    take_profit_1: r.take_profit_1,
    take_profit_2: r.take_profit_2,
    rr_ratio: r.rr_ratio,
    rr_num: rrNum,
    confidence: r.confidence,
    confidence_label: r.confidence_label,
    reasoning: r.reasoning,
    risk_amount: riskAmt,
    outcome: 'PENDING'
  };
  journal.unshift(entry);
  saveJournalData(journal);
  renderJournal();
  document.querySelector('.journal-section').scrollIntoView({behavior:'smooth',block:'start'});
  const btn = document.querySelector('.save-journal-btn');
  if(btn){ btn.textContent='‚úÖ SAVED TO JOURNAL'; btn.style.color='var(--green)'; setTimeout(()=>{ btn.textContent='üìã SAVE THIS SUGGESTION TO JOURNAL'; btn.style.color=''; },2000); }
}

function setOutcome(id, outcome){
  const journal = loadJournal();
  const entry = journal.find(e=>e.id===id);
  if(!entry) return;
  entry.outcome = entry.outcome === outcome ? 'PENDING' : outcome;
  saveJournalData(journal);
  renderJournal();
}

function deleteEntry(id){
  const journal = loadJournal().filter(e=>e.id!==id);
  saveJournalData(journal);
  renderJournal();
}

function clearJournal(){
  if(!confirm('Clear all journal records? This cannot be undone.')) return;
  localStorage.removeItem('apexJournal');
  renderJournal();
}

function calcPnl(entry){
  // WIN = gained risk * RR, LOSS = lost risk amount, MISS/PENDING = 0
  if(entry.outcome === 'WIN') return +(entry.risk_amount * entry.rr_num).toFixed(2);
  if(entry.outcome === 'LOSS') return -(entry.risk_amount).toFixed(2);
  return 0;
}

function renderJournal(){
  const journal = loadJournal();
  const acct = loadAccountSettings();
  const body = document.getElementById('journalBody');

  // Populate account fields
  document.getElementById('startBalance').value = acct.balance;
  document.getElementById('riskPct').value = acct.risk;

  // Calc account stats ‚Äî process in reverse (oldest first) for running balance
  const riskAmt = getRiskAmount(acct.balance, acct.risk);
  let totalGained = 0, totalLost = 0;
  const decided = journal.filter(e=>e.outcome!=='PENDING' && e.outcome!=='MISS');
  decided.forEach(e=>{
    const pnl = calcPnl(e);
    if(pnl > 0) totalGained += pnl;
    if(pnl < 0) totalLost += Math.abs(pnl);
  });
  const totalPnl = totalGained - totalLost;
  const currentBalance = acct.balance + totalPnl;
  const growth = ((currentBalance - acct.balance) / acct.balance * 100).toFixed(1);

  // Stats bar
  const total = journal.length;
  const wins = journal.filter(e=>e.outcome==='WIN').length;
  const losses = journal.filter(e=>e.outcome==='LOSS').length;
  const misses = journal.filter(e=>e.outcome==='MISS').length;
  const pending = journal.filter(e=>e.outcome==='PENDING').length;
  const decidedCount = wins + losses;
  const rate = decidedCount>0 ? Math.round((wins/decidedCount)*100)+'%' : '‚Äî';

  // Update DOM
  document.getElementById('ac-start').textContent = '$'+acct.balance.toLocaleString();
  document.getElementById('ac-current').textContent = '$'+currentBalance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  document.getElementById('ac-current').style.color = currentBalance >= acct.balance ? 'var(--green)' : 'var(--red)';
  document.getElementById('ac-risk').textContent = '$'+riskAmt.toFixed(0);
  document.getElementById('ac-pnl').textContent = (totalPnl>=0?'+':'')+'$'+totalPnl.toFixed(0);
  document.getElementById('ac-pnl').style.color = totalPnl>0?'var(--green)':totalPnl<0?'var(--red)':'var(--muted)';
  document.getElementById('ac-gained').textContent = '+$'+totalGained.toFixed(0);
  document.getElementById('ac-lost').textContent = '-$'+totalLost.toFixed(0);
  document.getElementById('ac-growth').textContent = (growth>=0?'+':'')+growth+'%';
  document.getElementById('ac-growth').style.color = growth>=0?'var(--green)':'var(--red)';
  document.getElementById('ac-start').textContent = '$'+acct.balance.toLocaleString();
  document.getElementById('st-total').textContent = total;
  document.getElementById('st-win').textContent = wins;
  document.getElementById('st-loss').textContent = losses;
  document.getElementById('st-miss').textContent = misses;
  document.getElementById('st-pend').textContent = pending;
  document.getElementById('st-rate').textContent = rate;

  if(!journal.length){
    body.innerHTML=`<tr><td colspan="14" class="empty-journal">No trades recorded yet ‚Äî run an analysis and save it to the journal</td></tr>`;
    return;
  }

  body.innerHTML = journal.map((e,i)=>{
    const isBuy = ['BUY','CONFIRMED'].includes(e.direction);
    const isSell = ['SELL'].includes(e.direction);
    const dirClass = isBuy?'dir-mini-buy':isSell?'dir-mini-sell':'dir-mini-other';
    const confClass = {'STRONG':'conf-strong','GOOD':'conf-good','VALID':'conf-valid'}[e.confidence_label]||'';
    const rowClass = {'WIN':'outcome-win','LOSS':'outcome-loss','MISS':'outcome-miss'}[e.outcome]||'outcome-pending';
    const rrNum = e.rr_num || parseFloat((e.rr_ratio||'0').split(':')[1]||0);
    const rrColor = rrNum>=10?'var(--gold)':rrNum>=5?'var(--green)':'var(--muted)';
    const risk = e.risk_amount || getRiskAmount(acct.balance, acct.risk);
    const pnl = calcPnl(e);
    const pnlColor = pnl>0?'var(--green)':pnl<0?'var(--red)':'var(--muted)';
    const pnlText = e.outcome==='PENDING'?'‚Äî': e.outcome==='MISS'?'‚Äî': (pnl>=0?'+':'')+'$'+Math.abs(pnl).toFixed(0);

    return `<tr class="${rowClass}">
      <td style="color:var(--muted)">${journal.length - i}</td>
      <td style="color:var(--muted);font-size:10px">${e.timestamp}</td>
      <td style="font-weight:700;color:var(--text)">${e.pair}</td>
      <td><span class="dir-mini ${dirClass}">${e.direction}</span></td>
      <td style="color:var(--accent);font-size:11px">${e.entry_zone||'‚Äî'}</td>
      <td style="color:var(--red);font-size:11px">${e.stop_loss||'‚Äî'}</td>
      <td style="color:var(--green);font-size:11px">${e.take_profit_1||'‚Äî'}</td>
      <td style="color:#00e5b0;font-size:11px">${e.take_profit_2||'‚Äî'}</td>
      <td style="color:${rrColor};font-weight:600">${e.rr_ratio||'‚Äî'}</td>
      <td style="color:var(--warn);font-weight:600">$${risk.toFixed(0)}</td>
      <td style="color:${pnlColor};font-weight:700">${pnlText}</td>
      <td><span class="conf-mini ${confClass}">${e.confidence_label||'‚Äî'} ${e.confidence?e.confidence+'%':''}</span></td>
      <td>
        <div class="outcome-btns">
          <button class="obtn obtn-win ${e.outcome==='WIN'?'active':''}" onclick="setOutcome(${e.id},'WIN')">WIN</button>
          <button class="obtn obtn-loss ${e.outcome==='LOSS'?'active':''}" onclick="setOutcome(${e.id},'LOSS')">LOSS</button>
          <button class="obtn obtn-miss ${e.outcome==='MISS'?'active':''}" onclick="setOutcome(${e.id},'MISS')">MISS</button>
        </div>
      </td>
      <td><button class="obtn obtn-del" onclick="deleteEntry(${e.id})">‚úï</button></td>
    </tr>`;
  }).join('');
}

// Init ‚Äî load account settings and render
(function(){
  const acct = loadAccountSettings();
  document.getElementById('startBalance').value = acct.balance;
  document.getElementById('riskPct').value = acct.risk;
  document.getElementById('balance').value = acct.balance;
  document.getElementById('risk').value = acct.risk;
  renderJournal();
})();
</script>
</body>
</html>
